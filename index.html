<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<title>–ú–æ–±–∏–ª—å–Ω—ã–π –Ω–∞–≤–∏–≥–∞—Ç–æ—Ä —Å OSRM Trip</title>
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no" />
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
<style>
html,body{margin:0;padding:0;height:100%;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;}
#map{height:100vh;width:100vw;}
#file-input{position:absolute;z-index:1200;left:50%;transform:translateX(-50%);top:10px;background:#fff;padding:6px;border-radius:10px;box-shadow:0 2px 8px rgba(0,0,0,0.15);display:flex;gap:6px;align-items:center;flex-wrap:wrap;max-width:95%;}
#file-input input[type=file]{font-size:13px;}
#file-input button{font-size:14px;padding:6px 8px;border-radius:6px;border:1px solid #ccc;background:#f7f7f7;cursor:pointer;}
#info-box{position:absolute;bottom:10px;left:50%;transform:translateX(-50%);z-index:1000;background:rgba(255,255,255,0.95);padding:6px 10px;border-radius:8px;box-shadow:0 2px 5px rgba(0,0,0,0.3);min-width:150px;text-align:center;font-size:14px;}
.leaflet-bottom .leaflet-control-zoom{top:50%;bottom:auto;transform:translateY(-50%);}
#centerUserBtn{position:absolute;bottom:80px;right:10px;z-index:1200;background:#fff;border:none;border-radius:50%;width:45px;height:45px;cursor:pointer;box-shadow:0 2px 6px rgba(0,0,0,0.3);display:flex;justify-content:center;align-items:center;transition:transform 0.15s ease;}
#centerUserBtn:hover{transform:scale(1.1);}
#centerUserBtn svg{width:24px;height:24px;stroke:#0077cc;stroke-width:2;fill:none;}
#version-label{position:absolute;bottom:10px;left:10px;color:#000;font-size:12px;z-index:1200;text-shadow:0 0 3px rgba(0,0,0,0.7);}
textarea{resize:none;font-size:13px;}
button{font-size:14px;padding:4px 6px;}
.waypoint-label div {
  color: white;
  font-weight: bold;
  font-size: 14px;
  line-height: 1;
  text-shadow:
    -1px -1px 0 #000,
    1px -1px 0 #000,
    -1px 1px 0 #000,
    1px 1px 0 #000;
}
.popup-readonly { width:100%; margin-bottom:6px; background:#eee; border:1px solid #ddd; padding:6px; box-sizing:border-box; }
.popup-input { width:100%; margin-bottom:6px; padding:6px; box-sizing:border-box; }
.popup-btn { width:100%; padding:8px; margin-bottom:6px; cursor:pointer; }
</style>
</head>
<body>

<div id="file-input">
  <input type="file" id="csvFile" accept=".csv" />
  <button id="locBtn">GPS</button>
  <button id="refreshBtn">–û–±–Ω–æ–≤–∏—Ç—å</button>
  <button id="clearBtn">–û—á–∏—Å—Ç–∏—Ç—å</button>
  <button id="downloadBtn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
  <button id="navStartBtn">–°—Ç–∞—Ä—Ç</button>
  <button id="navStopBtn">–°—Ç–æ–ø</button>
</div>

<div id="info-box">
  <b>–ú–∞—Ä—à—Ä—É—Ç</b><br>
  <span id="info-distance">–î–ª–∏–Ω–∞: ‚Äî</span><br>
  <span id="info-duration">–í—Ä–µ–º—è: ‚Äî</span>
</div>

<div id="map"></div>

<button id="centerUserBtn">
<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
<circle cx="12" cy="12" r="10"/>
<line x1="12" y1="2" x2="12" y2="6"/>
<line x1="12" y1="18" x2="12" y2="22"/>
<line x1="2" y1="12" x2="6" y2="12"/>
<line x1="18" y1="12" x2="22" y2="12"/>
</svg>
</button>

<div id="version-label">–≤–µ—Ä—Å–∏—è 3.2</div>

<script>
const map = L.map('map', {zoomControl:false}).setView([51.16,71.47],12);
L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
L.control.zoom({position:'bottomleft'}).addTo(map);

let csvMarkersLayer = L.layerGroup().addTo(map);
let routeLayer = L.layerGroup().addTo(map);
let labelLayer = L.layerGroup().addTo(map);
let userMarker = null;
let autoFollow = true;
let csvData = [];
let csvFileName = '';
let userCoords = null;
let activeRouteCoords = [];
let osrmCoords = [];
let userRadius = null;

let navRouteCoords = [];
let navWatchId = null;
let remainingRouteLayer = null;
let userHeading = 0;

const infoDistanceEl = document.getElementById('info-distance');
const infoDurationEl = document.getElementById('info-duration');

map.on('movestart zoomstart',()=>{autoFollow=false;});

function centerOnUser(zoom=15){ if(userCoords) map.flyTo(userCoords,zoom,{duration:1.0}); }

// ===== Auto-update status when entering radius =====
function checkPointsInUserRadius() {
  if(!userCoords) return;
  let changed = false;
  csvData.forEach((p,i)=>{
    if(String(p.status) === "0"){ // only status "0" can change to "1" by proximity
      const d = L.latLng(userCoords).distanceTo(L.latLng([p.lat,p.lon]));
      if(d <= 50){
        p.status = "1";
        const marker = csvMarkersLayer.getLayers()[i];
        if(marker && marker.setStyle) marker.setStyle({color:'green', fillColor:'green'});
        changed = true;
      }
    }
  });
  if(changed) buildOptimizedRoute();
}

// ===== User marker creation/update (circle or triangle) =====
function createUserMarker(coords, type="circle", heading=0){
  if(userMarker){ try{ map.removeLayer(userMarker); }catch(e){} }
  if(type==="circle"){
    userMarker = L.circleMarker(coords,{radius:6,color:'#0077cc',fillColor:'#0077cc',fillOpacity:0.8}).addTo(map).bindPopup('–í—ã –∑–¥–µ—Å—å');
  } else {
    const triangleIcon = L.divIcon({
      className: '',
      html: `<svg width="28" height="28" viewBox="0 0 30 30" style="transform:rotate(${heading}deg); display:block;">
              <polygon points="15,0 30,30 0,30" fill="white" stroke="black" stroke-width="2"/>
            </svg>`,
      iconSize: [28,28],
      iconAnchor: [14,14]
    });
    userMarker = L.marker(coords,{icon:triangleIcon}).addTo(map).bindPopup('–í—ã –∑–¥–µ—Å—å');
  }
}

function updateUserPosition(pos){ 
  const newCoords = [pos.coords.latitude,pos.coords.longitude];
  if(!userMarker){ createUserMarker(newCoords); } 
  else {
    if(userMarker.setLatLng) userMarker.setLatLng(newCoords);
  }
  userCoords = newCoords;
  if(!userRadius) userRadius = L.circle(userCoords,{radius:50,color:'black',weight:1,fillOpacity:0}).addTo(map);
  else userRadius.setLatLng(userCoords);
  checkPointsInUserRadius();
  if(autoFollow) centerOnUser(); 
}

function requestUserLocation(){ 
  if(!navigator.geolocation){alert('–ì–µ–æ–ª–æ–∫–∞—Ü–∏—è –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è');return;} 
  navigator.geolocation.getCurrentPosition(updateUserPosition,err=>alert('GPS –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω'),{enableHighAccuracy:true}); 
}

// ================= Build OSRM Route =================
function buildOptimizedRoute(){
  routeLayer.clearLayers();
  labelLayer.clearLayers();
  activeRouteCoords = csvData.filter(p => String(p.status) === "0").map(p => [Number(p.lat), Number(p.lon)]);
  osrmCoords = [...activeRouteCoords];

  if(osrmCoords.length === 0){
    infoDistanceEl.textContent='–î–ª–∏–Ω–∞: ‚Äî';
    infoDurationEl.textContent='–í—Ä–µ–º—è: ‚Äî';
    navRouteCoords = [];
    if(remainingRouteLayer){ remainingRouteLayer.clearLayers(); remainingRouteLayer=null; }
    return;
  }

  const tripCoords = userCoords ? [userCoords, ...osrmCoords] : osrmCoords;
  const coordStr = tripCoords.map(c => `${c[1]},${c[0]}`).join(';');

  fetch(`https://router.project-osrm.org/trip/v1/driving/${coordStr}?source=first&roundtrip=false&overview=full&geometries=geojson`)
    .then(r=>r.json())
    .then(json=>{
      if(!json || (json.code && json.code !== 'Ok') || !json.trips || !json.trips.length){
        console.error('OSRM error or empty response', json);
        alert('OSRM –Ω–µ —Å–º–æ–≥ –ø–æ—Å—Ç—Ä–æ–∏—Ç—å –º–∞—Ä—à—Ä—É—Ç. –í—ã–ø–æ–ª–Ω–µ–Ω —Ñ–æ–ª–±—ç–∫.');
        fallbackDraw();
        return;
      }
      const trip = json.trips[0];
      routeLayer.clearLayers();
      L.geoJSON(trip.geometry,{style:{color:'#0077cc',weight:3,opacity:0.9}}).addTo(routeLayer);
      navRouteCoords = trip.geometry.coordinates.map(c => [c[1],c[0]]);

      // ================= –õ–µ–π–±–ª—ã –ø–æ –ø–æ—Ä—è–¥–∫—É OSRM (–ø—Ä–æ–ø—É—Å–∫–∞–µ–º –ø–µ—Ä–≤—ã–π waypoint - –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å) =================
      try{
        labelLayer.clearLayers();
        if(trip.waypoints && trip.waypoints.length > 1){
          const csvWaypoints = trip.waypoints.slice(1); // –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –ø–µ—Ä–≤—ã–π waypoint (–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å)
          csvWaypoints.forEach((wp, idx) => {
            const lat = wp.location[1];
            const lon = wp.location[0];
            L.marker([lat, lon], {
              icon: L.divIcon({
                className: 'waypoint-label',
                html: `<div>${idx+1}</div>`,
                iconSize: null,
                iconAnchor: [0,0]
              }),
              interactive: false
            }).addTo(labelLayer);
          });
        } else {
          // –µ—Å–ª–∏ –Ω–µ—Ç waypoints, –º–æ–∂–Ω–æ –ø–æ—Å—Ç–∞–≤–∏—Ç—å –Ω–æ–º–µ—Ä–∞ –≤ –∏—Å—Ö–æ–¥–Ω–æ–º –ø–æ—Ä—è–¥–∫–µ osrmCoords
          osrmCoords.forEach((c, idx)=>{
            L.marker([c[0], c[1]], {
              icon: L.divIcon({
                className: 'waypoint-label',
                html: `<div>${idx+1}</div>`,
                iconSize: null,
                iconAnchor: [0,0]
              }),
              interactive: false
            }).addTo(labelLayer);
          });
        }
      }catch(e){ console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ—Å—Ç–∞–Ω–æ–≤–∫–µ –ª–µ–π–±–ª–æ–≤', e); }

      const distanceKm = (trip.distance/1000).toFixed(2);
      infoDistanceEl.textContent = `–î–ª–∏–Ω–∞: ${distanceKm} –∫–º`;
      const totalMinutes = Math.round(trip.duration/60);
      infoDurationEl.textContent = totalMinutes<60?`${totalMinutes} –º–∏–Ω`:`${Math.floor(totalMinutes/60)} —á ${totalMinutes%60} –º–∏–Ω`;
      if(userCoords) centerOnUser(15);
    })
    .catch(err=>{
      console.error('–û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –∫ OSRM', err);
      alert('–û—à–∏–±–∫–∞ OSRM (—Å–µ—Ç–µ–≤–∞—è –∏–ª–∏ CORS). –í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è —Ñ–æ–ª–±—ç–∫.');
      fallbackDraw();
    });

  // ----- –§–æ–ª–±—ç–∫: –ø—Ä–æ—Å—Ç–∞—è –ª–∏–Ω–∏—è –ø–æ —Ç–æ—á–∫–∞–º –∏ –Ω—É–º–µ—Ä–∞—Ü–∏—è –≤ –∏—Å—Ö–æ–¥–Ω–æ–º –ø–æ—Ä—è–¥–∫–µ -----
  function fallbackDraw(){
    try {
      routeLayer.clearLayers();
      labelLayer.clearLayers();
      if(!osrmCoords || !osrmCoords.length){
        infoDistanceEl.textContent='–î–ª–∏–Ω–∞: ‚Äî';
        infoDurationEl.textContent='–í—Ä–µ–º—è: ‚Äî';
        navRouteCoords = [];
        return;
      }
      L.polyline(osrmCoords, {color:'#0077cc', weight:3, opacity:0.9}).addTo(routeLayer);
      navRouteCoords = osrmCoords.slice();
      osrmCoords.forEach((c, idx) => {
        L.marker([c[0], c[1]], {
          icon: L.divIcon({
            className: 'waypoint-label',
            html: `<div>${idx + 1}</div>`,
            iconSize: null
          }),
          interactive: false
        }).addTo(labelLayer);
      });
      infoDistanceEl.textContent='–î–ª–∏–Ω–∞: ‚Äî';
      infoDurationEl.textContent='–í—Ä–µ–º—è: ‚Äî';
    } catch (e) {
      console.error('–û—à–∏–±–∫–∞ —Ñ–æ–ª–±—ç–∫–∞', e);
    }
  }
}

// ================= CREATE POPUP with name/subname controls =================
function createPopup(point, marker, index){
  // Ensure the fields exist on point
  if (point.name === undefined) point.name = "";
  if (point.subname === undefined) point.subname = "";
  if (point.name_ch === undefined) point.name_ch = "";
  if (point.subname_ch === undefined) point.subname_ch = "";
  if (point.comment === undefined) point.comment = "";

  const container=document.createElement('div');
  container.style.display='flex'; container.style.flexDirection='column'; container.style.gap='6px';
  container.style.fontSize='13px';
  container.style.minWidth='240px';

  // LAT/LON + copy
  const latDiv=document.createElement('div');
  latDiv.style.display='flex'; latDiv.style.gap='6px';
  const latInput=document.createElement('input');
  latInput.type='text';
  latInput.value=`${point.lat}, ${point.lon}`;
  latInput.readOnly=true;
  latInput.className='popup-readonly';
  latDiv.appendChild(latInput);
  const copyBtn=document.createElement('button');
  copyBtn.textContent='üìã'; copyBtn.title='–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å'; copyBtn.style.fontSize='14px';
  copyBtn.addEventListener('click',()=>{ navigator.clipboard.writeText(latInput.value); copyBtn.textContent='‚úî'; setTimeout(()=>copyBtn.textContent='üìã',1000); });
  latDiv.appendChild(copyBtn);
  container.appendChild(latDiv);

  // NAME readonly
  const nameLabel = document.createElement('div'); nameLabel.textContent='name:'; nameLabel.style.fontWeight='600';
  const nameRead = document.createElement('input'); nameRead.type='text'; nameRead.value=point.name||''; nameRead.readOnly=true; nameRead.className='popup-readonly';
  container.appendChild(nameLabel); container.appendChild(nameRead);

  // name_ch editable
  const nameChLabel = document.createElement('div'); nameChLabel.textContent='–∏–∑–º–µ–Ω–µ–Ω–∏–µ name:'; 
  const nameChInput = document.createElement('input'); nameChInput.type='text'; nameChInput.value = point.name_ch || ''; nameChInput.className='popup-input';
  container.appendChild(nameChLabel); container.appendChild(nameChInput);

  // SUBNAME readonly
  const subLabel = document.createElement('div'); subLabel.textContent='subname:'; subLabel.style.fontWeight='600';
  const subRead = document.createElement('input'); subRead.type='text'; subRead.value=point.subname||''; subRead.readOnly=true; subRead.className='popup-readonly';
  container.appendChild(subLabel); container.appendChild(subRead);

  // subname_ch editable
  const subChLabel = document.createElement('div'); subChLabel.textContent='–∏–∑–º–µ–Ω–µ–Ω–∏–µ subname:';
  const subChInput = document.createElement('input'); subChInput.type='text'; subChInput.value = point.subname_ch || ''; subChInput.className='popup-input';
  container.appendChild(subChLabel); container.appendChild(subChInput);

  // Buttons: "–í—Å–µ —Ö–æ—Ä–æ—à–æ" and "–ù—É–∂–Ω—ã –∏–∑–º–µ–Ω–µ–Ω–∏—è"
  const okBtn = document.createElement('button'); okBtn.textContent='–í—Å–µ —Ö–æ—Ä–æ—à–æ'; okBtn.className='popup-btn';
  const needBtn = document.createElement('button'); needBtn.textContent='–ù—É–∂–Ω—ã –∏–∑–º–µ–Ω–µ–Ω–∏—è'; needBtn.className='popup-btn';
  container.appendChild(okBtn); container.appendChild(needBtn);

  // Comment area (kept from previous UI)
  const commentLabel = document.createElement('div'); commentLabel.textContent='comment:'; commentLabel.style.fontWeight='600';
  const commentInput = document.createElement('textarea'); commentInput.rows=2; commentInput.value=point.comment||''; commentInput.className='popup-input';
  const commentSave = document.createElement('button'); commentSave.textContent='üíæ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π'; commentSave.className='popup-btn';
  container.appendChild(commentLabel); container.appendChild(commentInput); container.appendChild(commentSave);

  // Event handlers
  okBtn.addEventListener('click', ()=>{
    if(nameChInput.value.trim() !== "" || subChInput.value.trim() !== ""){
      alert('–µ—Å—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è');
      return;
    }
    point.status = "1";
    point.name_ch = "";
    point.subname_ch = "";
    // update marker color
    const m = csvMarkersLayer.getLayers()[index];
    if(m && m.setStyle) m.setStyle({color:'green', fillColor:'green'});
    // ensure nav rebuild
    buildOptimizedRoute();
    marker.closePopup();
  });

  needBtn.addEventListener('click', ()=>{
    if(nameChInput.value.trim() === "" || subChInput.value.trim() === ""){
      alert('–Ω–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π');
      return;
    }
    point.status = "2";
    point.name_ch = nameChInput.value;
    point.subname_ch = subChInput.value;
    const m = csvMarkersLayer.getLayers()[index];
    if(m && m.setStyle) m.setStyle({color:'#f39c12', fillColor:'#f39c12'}); // orange for "needs changes"
    buildOptimizedRoute();
    marker.closePopup();
  });

  commentSave.addEventListener('click', ()=>{
    point.comment = commentInput.value;
    // no further action required
    commentSave.textContent = '‚úî';
    setTimeout(()=>commentSave.textContent = 'üíæ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π', 1000);
  });

  return container;
}

// ================= EVENTS and CSV loading =================
document.getElementById('csvFile').addEventListener('change', function(ev){
  const file=ev.target.files[0]; if(!file) return; csvFileName=file.name;
  Papa.parse(file,{header:true,dynamicTyping:false,skipEmptyLines:true,complete:function(results){
    const data=results.data||[]; 
    csvData=[]; 
    csvMarkersLayer.clearLayers(); 
    routeLayer.clearLayers();
    labelLayer.clearLayers();
    activeRouteCoords=[]; 
    osrmCoords=[];

    data.forEach((r,i)=>{
      const lat = r.lat !== undefined ? r.lat : (r.latitude !== undefined ? r.latitude : '');
      const lon = r.lon !== undefined ? r.lon : (r.longitude !== undefined ? r.longitude : '');
      const status = (String(r.status) === "1") ? "1" : ((String(r.status) === "2") ? "2" : "0");
      const comment = r.comment || "";
      const name = r.name || "";
      const subname = r.subname || "";
      const name_ch = r.name_ch || "";
      const subname_ch = r.subname_ch || "";

      // push object (ensure fields exist)
      csvData.push({lat,lon,status,comment,name,subname,name_ch,subname_ch});

      const color = status === "0" ? 'red' : (status === "1" ? 'green' : (status === "2" ? '#f39c12' : 'red'));
      // marker order must match csvData index for checkPointsInUserRadius()
      const marker = L.circleMarker([lat,lon],{radius:6,color:color,fillColor:color,fillOpacity:0.8}).addTo(csvMarkersLayer);
      marker.bindPopup(createPopup(csvData[i],marker,i),{minWidth:240});
    });

    buildOptimizedRoute();
  }});
});

document.getElementById('downloadBtn').addEventListener('click', ()=>{
  if(!csvData.length){ alert('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö'); return; }
  const csv=Papa.unparse(csvData);
  const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'});
  const url=URL.createObjectURL(blob); 
  const link=document.createElement('a'); 
  link.href=url; 
  link.download=csvFileName||'updated.csv';
  document.body.appendChild(link); link.click(); document.body.removeChild(link); URL.revokeObjectURL(url);
});

document.getElementById('locBtn').addEventListener('click',()=>{ autoFollow=true; requestUserLocation(); });
document.getElementById('refreshBtn').addEventListener('click',()=>{ buildOptimizedRoute(); });
document.getElementById('clearBtn').addEventListener('click',()=>{ 
  csvMarkersLayer.clearLayers(); 
  routeLayer.clearLayers(); 
  labelLayer.clearLayers();
  if(remainingRouteLayer){ remainingRouteLayer.clearLayers(); remainingRouteLayer=null; }
  document.getElementById('csvFile').value=''; 
  csvData=[]; activeRouteCoords=[]; osrmCoords=[]; navRouteCoords=[]; 
  infoDistanceEl.textContent='–î–ª–∏–Ω–∞: ‚Äî'; 
  infoDurationEl.textContent='–í—Ä–µ–º—è: ‚Äî'; 
});
document.getElementById('centerUserBtn').addEventListener('click',()=>{ if(userCoords){ autoFollow=true; centerOnUser(); } });

// ================= REAL GPS NAVIGATION (with remaining route and 200m yellow line) =================
function startRealNavigation(){
  if(!navRouteCoords.length){ alert('–ù–µ—Ç –º–∞—Ä—à—Ä—É—Ç–∞ –¥–ª—è –Ω–∞–≤–∏–≥–∞—Ü–∏–∏'); return; }
  if(!navigator.geolocation){ alert('–ì–µ–æ–ª–æ–∫–∞—Ü–∏—è –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è'); return; }
  if(navWatchId) navigator.geolocation.clearWatch(navWatchId);
  if(!remainingRouteLayer) remainingRouteLayer = L.layerGroup().addTo(map);

  navWatchId = navigator.geolocation.watchPosition(pos=>{
    const newCoords = [pos.coords.latitude,pos.coords.longitude];

    // compute heading from previous userCoords if exists
    if(userCoords){
      const dx = newCoords[1]-userCoords[1];
      const dy = newCoords[0]-userCoords[0];
      // atan2(dy,dx) returns radians; we convert and adjust so triangle points forward
      userHeading = Math.atan2(dy,dx) * 180/Math.PI + 90;
    }

    userCoords = newCoords;
    createUserMarker(userCoords,"triangle",userHeading);

    if(!userRadius) userRadius = L.circle(userCoords,{radius:50,color:'black',weight:1,fillOpacity:0}).addTo(map);
    else userRadius.setLatLng(userCoords);

    checkPointsInUserRadius();
    if(autoFollow) centerOnUser();

    // –û—Å—Ç–∞—Ç–æ–∫ –º–∞—Ä—à—Ä—É—Ç–∞ –∫—Ä–∞—Å–Ω–æ–π –ª–∏–Ω–∏–µ–π
    if(navRouteCoords.length>0){
      let nearestIndex=0, minDist=Infinity;
      for(let i=0;i<navRouteCoords.length;i++){
        const dx=userCoords[0]-navRouteCoords[i][0], dy=userCoords[1]-navRouteCoords[i][1];
        const dist=Math.sqrt(dx*dx+dy*dy);
        if(dist<minDist){ minDist=dist; nearestIndex=i; }
      }
      remainingRouteLayer.clearLayers();
      let points=[[userCoords[0],userCoords[1]], navRouteCoords[nearestIndex]];
      L.polyline(points,{color:'red',weight:3,opacity:0.9}).addTo(remainingRouteLayer);
      let remainingPoints=navRouteCoords.slice(nearestIndex);
      L.polyline(remainingPoints,{color:'red',weight:3,opacity:0.9}).addTo(remainingRouteLayer);
    
      // –ñ—ë–ª—Ç–∞—è –ª–∏–Ω–∏—è 200–º
      let yellowLineCoords=[[userCoords[0],userCoords[1]]];
      let distAccum = 0;
      for(let i=nearestIndex; i<navRouteCoords.length-1; i++){
        const from = L.latLng(navRouteCoords[i]);
        const to = L.latLng(navRouteCoords[i+1]);
        const segDist = from.distanceTo(to);
        if(distAccum + segDist > 200){
          const remaining = 200 - distAccum;
          const ratio = remaining/segDist;
          const lat = from.lat + (to.lat - from.lat) * ratio;
          const lng = from.lng + (to.lng - from.lng) * ratio;
          yellowLineCoords.push([lat,lng]);
          break;
        } else {
          yellowLineCoords.push([to.lat,to.lng]);
          distAccum += segDist;
        }
      }
      L.polyline(yellowLineCoords,{color:'yellow',weight:4,opacity:0.9}).addTo(remainingRouteLayer);
    }

  }, err=>alert('–û—à–∏–±–∫–∞ GPS'), {enableHighAccuracy:true, maximumAge:0, timeout:5000});
}

function stopRealNavigation(){ 
  if(navWatchId){ navigator.geolocation.clearWatch(navWatchId); navWatchId=null; } 
  if(remainingRouteLayer){ remainingRouteLayer.clearLayers(); } 
  if(userCoords) createUserMarker(userCoords,"circle");
}

document.getElementById('navStartBtn').addEventListener('click', startRealNavigation);
document.getElementById('navStopBtn').addEventListener('click', stopRealNavigation);

</script>
</body>
</html>

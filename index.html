<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<title>Карта + GPS + Полигоны + Точки</title>
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no" />

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

<style>
  html, body { margin: 0; padding: 0; height: 100%; }
  #map { height: 100vh; width: 100vw; }

  #gpsBtn {
    position: absolute;
    top: 10px;
    left: 50%;
    transform: translateX(-50%);
    z-index: 1000;
    padding: 10px 15px;
    background: white;
    border-radius: 8px;
    border: 1px solid #ccc;
    font-size: 15px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.3);
  }

  #copyToast {
    position: fixed;
    bottom: 25px;
    left: 50%;
    transform: translateX(-50%);
    background: #2b2bff;
    color: white;
    padding: 8px 14px;
    border-radius: 6px;
    font-size: 14px;
    display: none;
    z-index: 2000;
  }
</style>
</head>

<body>

<button id="gpsBtn">GPS</button>
<div id="map"></div>
<div id="copyToast">Скопировано!</div>

<script>
// ------------------ карта ------------------
const defaultCenter = [-8.05, -34.9];
const map = L.map('map').setView(defaultCenter, 13);

L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

// слои
const polygonsLayer = L.layerGroup().addTo(map);
const pointsLayer = L.layerGroup().addTo(map);

// ------------------ GPS ------------------
let userMarker = null;
let watchId = null;

function updateUserPosition(pos) {
  const lat = pos.coords.latitude;
  const lon = pos.coords.longitude;

  if (!userMarker) {
    userMarker = L.marker([lat, lon]).addTo(map).bindPopup("Вы здесь");
    userMarker.openPopup();
  } else {
    userMarker.setLatLng([lat, lon]);
  }

  map.setView([lat, lon], 17);
}

document.getElementById("gpsBtn").addEventListener("click", () => {
  if (!navigator.geolocation) {
    alert("Геолокация не поддерживается.");
    return;
  }

  navigator.geolocation.getCurrentPosition(
    (pos) => {
      updateUserPosition(pos);
      if (watchId === null) {
        watchId = navigator.geolocation.watchPosition(
          updateUserPosition,
          (err) => console.warn("watchPosition error", err),
          { enableHighAccuracy: true, maximumAge: 1000, timeout: 15000 }
        );
      }
    },
    () => alert("Разрешите доступ к геолокации."),
    { enableHighAccuracy: true }
  );
});

// ------------------ Toast копирования ------------------
function showCopiedToast() {
  const t = document.getElementById("copyToast");
  t.style.display = "block";
  setTimeout(() => t.style.display = "none", 1200);
}

// ------------------ Парсер POLYGON ------------------
function parseWKTPolygon(wkt) {
  const cleaned = wkt.replace("POLYGON", "").replace(/\(/g, "").replace(/\)/g, "").trim();
  const pairs = cleaned.split(",");
  return pairs.map(p => {
    const [lon, lat] = p.trim().split(" ").map(Number);
    return [lat, lon];
  });
}

// ------------------ Парсер POINT ------------------
function parseWKTPoint(wkt) {
  // формат: POINT(-34.12345 -8.12345)
  const cleaned = wkt.replace("POINT", "").replace("(", "").replace(")", "").trim();
  const [lon, lat] = cleaned.split(" ").map(Number);
  if (!isNaN(lat) && !isNaN(lon)) return [lat, lon];
  return null;
}

// ------------------ Загрузка полигонов ------------------
function loadPolygons() {
  fetch("poly.csv")
    .then(r => r.text())
    .then(txt => Papa.parse(txt, {
      header: true,
      skipEmptyLines: true,
      complete: res => {
        res.data.forEach(row => {
          if (!row.geom) return;
          if (row.deleted_at && row.deleted_at.trim() !== "") return; // фильтр

          if (row.geom.startsWith("POLYGON")) {
            const coords = parseWKTPolygon(row.geom);
            if (coords.length) {
              const poly = L.polygon(coords, {
                color: "blue",
                weight: 2,
                fillColor: "blue",
                fillOpacity: 0.2
              }).addTo(polygonsLayer);

              if (row.name) poly.bindTooltip(row.name);

              poly.on("mouseover", function () {
                this.setStyle({ weight: 4, fillOpacity: 0.35 });
              });
              poly.on("mouseout", function () {
                this.setStyle({ weight: 2, fillOpacity: 0.2 });
              });

              poly.on("click", () => {
                const popupContent = `
                  <div style="font-size:15px;min-width:180px;">
                    <b>Название:</b><br>
                    <input id="polyNameField" value="${row.name || ''}" readonly 
                      style="width:100%;margin-top:4px;padding:6px;font-size:14px;">
                    <button onclick="copyPolygonName()"
                      style="margin-top:8px;width:100%;padding:6px;border-radius:6px;border:1px solid #666;background:#eee;">
                      Скопировать
                    </button>
                  </div>
                `;
                poly.bindPopup(popupContent).openPopup();
              });
            }
          }
        });

        if (polygonsLayer.getLayers().length > 0)
          map.fitBounds(polygonsLayer.getBounds());
      }
    }));
}

window.copyPolygonName = function () {
  const el = document.getElementById("polyNameField");
  if (el) navigator.clipboard.writeText(el.value);
  showCopiedToast();
};

// ------------------ Загрузка точек pups_m.csv ------------------
function loadPoints() {
  fetch("pups_m.csv")
    .then(r => r.text())
    .then(txt => Papa.parse(txt, {
      header: true,
      skipEmptyLines: true,
      complete: res => {
        res.data.forEach(row => {
          if (!row.geom) return;
          if (row.deleted_at && row.deleted_at.trim() !== "") return;

          if (row.geom.startsWith("POINT")) {
            const coords = parseWKTPoint(row.geom);
            if (!coords) return;

            const marker = L.marker(coords, {
              icon: L.icon({
                iconUrl: "https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-red.png",
                iconSize: [25, 41],
                iconAnchor: [12, 41]
              })
            }).addTo(pointsLayer);

            const name = row.name || "";
            const sub = row.subname || "";

            marker.bindTooltip(`<b>${name}</b><br>${sub}`);
          }
        });
      }
    }));
}

// ------------------ Старт ------------------
loadPolygons();
loadPoints();
</script>

</body>
</html>

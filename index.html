<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<title>Карта + GPS + Полигоны + Pup Points</title>
<meta name="viewport" content="width=device-width,initial-scale=1.0,user-scalable=no" />

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

<style>
html, body { margin:0; padding:0; height:100%; }
#map { height:100vh; width:100vw; }

#topPanel {
  position:absolute;
  top:10px;
  left:50%;
  transform:translateX(-50%);
  z-index:1500;
  display:flex;
  gap:8px;
}
#topPanel button {
  padding:8px 12px;
  font-size:14px;
  background:white;
  border:1px solid #ccc;
  border-radius:6px;
  cursor:pointer;
}

.popup-input{width:100%;padding:6px;margin-bottom:6px}
.popup-readonly{width:100%;padding:6px;margin-bottom:6px;background:#eee}
.popup-btn{width:100%;padding:6px;margin-bottom:4px;cursor:pointer}

.sub-label{
  font-size:14px;font-weight:bold;color:white;
  text-shadow:-1px -1px 0 black,1px -1px 0 black,-1px 1px 0 black,1px 1px 0 black;
  white-space:nowrap;transform:translate(-50%,-10px)
}
</style>
</head>

<body>

<div id="topPanel">
  <button id="openCsvBtn">Открыть CSV</button>
  <button id="saveCsvBtn">Сохранить CSV</button>
  <input type="file" id="csvFileInput" accept=".csv" style="display:none">
</div>

<div id="map"></div>

<script>
const map = L.map('map').setView([-8.05, -34.9], 13);
L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

const pointsLayer = L.layerGroup().addTo(map);

let pointsData = [];   // ВСЕ строки CSV
let markers = [];      // маркеры на карте

function normalizeCoord(v){
  if(!v) return null;
  return parseFloat(v.toString().replace(",",".").replace(/[^\d.-]/g,""));
}

// ===================== POPUP =====================
function createPopup(point, marker){
  const c=document.createElement("div");
  c.style.minWidth="220px";

  c.innerHTML=`
    name:<input class="popup-readonly" readonly value="${point.name||""}">
    изменение name:<input class="popup-input" id="nch" value="${point.name_ch||""}">
    subname:<input class="popup-readonly" readonly value="${point.subname||""}">
    изменение subname:<input class="popup-input" id="sch" value="${point.subname_ch||""}">
    <button class="popup-btn" id="ok">Все хорошо</button>
    <button class="popup-btn" id="need">Нужны изменения</button>
    <button class="popup-btn" id="clear">Очистить</button>
  `;

  const nch=c.querySelector("#nch");
  const sch=c.querySelector("#sch");

  c.querySelector("#ok").onclick=()=>{
    if(nch.value||sch.value){alert("есть изменения");return;}
    point.status="1"; point.name_ch=""; point.subname_ch="";
    marker.setIcon(greenIcon);
    marker.closePopup();
  };

  c.querySelector("#need").onclick=()=>{
    if(!nch.value||!sch.value){alert("нет изменений");return;}
    point.status="2";
    point.name_ch=nch.value;
    point.subname_ch=sch.value;
    marker.setIcon(orangeIcon);
    marker.closePopup();
  };

  c.querySelector("#clear").onclick=()=>{
    point.status="0";
    point.name_ch=""; point.subname_ch="";
    nch.value=""; sch.value="";
    marker.setIcon(redIcon);
  };

  return c;
}

// ===================== ICONS =====================
const redIcon = L.icon({iconUrl:"https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-red.png",
shadowUrl:"https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-shadow.png",iconSize:[25,41],iconAnchor:[12,41]});

const greenIcon = L.icon({iconUrl:"https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-green.png",
shadowUrl:"https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-shadow.png",iconSize:[25,41],iconAnchor:[12,41]});

const orangeIcon = L.icon({iconUrl:"https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-orange.png",
shadowUrl:"https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-shadow.png",iconSize:[25,41],iconAnchor:[12,41]});

// ===================== LOAD CSV =====================
document.getElementById("openCsvBtn").onclick=()=>{
  document.getElementById("csvFileInput").click();
};

document.getElementById("csvFileInput").addEventListener("change", e=>{
  const file=e.target.files[0];
  if(!file) return;

  Papa.parse(file,{
    header:true,
    skipEmptyLines:true,
    complete:(res)=>{
      pointsData=res.data;
      pointsLayer.clearLayers();
      markers=[];

      pointsData.forEach(p=>{
        if(p.deleted_at) return;

        const lat=normalizeCoord(p.lat);
        const lon=normalizeCoord(p.lon);
        if(isNaN(lat)||isNaN(lon)) return;

        const icon = p.status==="1"?greenIcon:p.status==="2"?orangeIcon:redIcon;
        const m=L.marker([lat,lon],{icon}).addTo(pointsLayer);
        m.bindPopup(createPopup(p,m));
        markers.push(m);

        if(p.subname){
          L.marker([lat,lon],{
            icon:L.divIcon({html:`<div class="sub-label">${p.subname}</div>`,iconSize:[0,0]}),
            interactive:false
          }).addTo(pointsLayer);
        }
      });
      map.fitBounds(pointsLayer.getBounds());
    }
  });
});

// ===================== SAVE CSV =====================
document.getElementById("saveCsvBtn").onclick=()=>{
  const csv = Papa.unparse(pointsData);
  const blob = new Blob([csv],{type:"text/csv;charset=utf-8;"});
  const a=document.createElement("a");
  a.href=URL.createObjectURL(blob);
  a.download="pups_m_updated.csv";
  a.click();
};
</script>
</body>
</html>

<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<title>Карта + GPS + Полигоны + Pup Points</title>
<meta name="viewport" content="width=device-width,initial-scale=1.0,user-scalable=no" />

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

<style>
  html, body {
    margin: 0; padding: 0; height: 100%;
  }
  #map { height: 100vh; width: 100vw; }

  #gpsBtn {
    position: absolute;
    top: 10px;
    left: 50%;
    transform: translateX(-50%);
    z-index: 1000;
    padding: 10px 15px;
    background: white;
    border-radius: 8px;
    border: 1px solid #ccc;
    font-size: 15px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.3);
  }

  /* Кнопка-прицел */
  #centerBtn {
    position: absolute;
    right: 15px;
    top: 80px;
    width: 50px;
    height: 50px;
    z-index: 1000;
    border-radius: 50%;
    background: white;
    border: 1px solid #ccc;
    box-shadow: 0 2px 6px rgba(0,0,0,0.4);
    display: flex;
    align-items: center;
    justify-content: center;
  }
  #centerBtn::before {
    content: "";
    width: 22px;
    height: 22px;
    border: 2px solid black;
    border-radius: 50%;
    position: relative;
  }
  #centerBtn::after {
    content: "";
    width: 3px;
    height: 3px;
    background: black;
    border-radius: 50%;
    position: absolute;
  }

  #copyToast {
    position: fixed;
    bottom: 25px;
    left: 50%;
    transform: translateX(-50%);
    background: #2b2bff;
    color: white;
    padding: 8px 14px;
    border-radius: 6px;
    font-size: 14px;
    display: none;
    z-index: 2000;
  }
</style>
</head>

<body>

<button id="gpsBtn">GPS</button>
<button id="centerBtn" style="display:none;"></button>

<div id="map"></div>
<div id="copyToast">Скопировано!</div>

<script>
// ======================= КАРТА ============================
const map = L.map('map').setView([-8.05, -34.9], 13);
L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

const polygonsLayer = L.layerGroup().addTo(map);
const pointsLayer = L.layerGroup().addTo(map);

// GPS
let userMarker = null;
let watchId = null;
let followEnabled = false;

// ====== Обновление GPS ======
function updateUserPosition(position) {
  const lat = position.coords.latitude;
  const lon = position.coords.longitude;

  if (!userMarker) {
    userMarker = L.marker([lat, lon]).addTo(map);
    document.getElementById("centerBtn").style.display = "flex";
  } else {
    userMarker.setLatLng([lat, lon]);
  }

  if (followEnabled) map.setView([lat, lon]);
}

// ====== Запуск GPS ======
document.getElementById("gpsBtn").addEventListener("click", () => {
  navigator.geolocation.getCurrentPosition(
    (pos) => {
      followEnabled = true;
      updateUserPosition(pos);

      if (!watchId) {
        watchId = navigator.geolocation.watchPosition(
          updateUserPosition,
          err => console.warn("watch error", err),
          { enableHighAccuracy: true, maximumAge: 1000, timeout: 15000 }
        );
      }
    },
    () => alert("Разрешите доступ к геолокации."),
    { enableHighAccuracy: true }
  );
});

// ====== Центрирование по кнопке-прицелу ======
document.getElementById("centerBtn").addEventListener("click", () => {
  if (!userMarker) return;
  const p = userMarker.getLatLng();
  followEnabled = true; // при нажатии снова включается follow
  map.setView(p, map.getZoom());
});

// ====== Если пользователь двигает карту — follow выключается ======
map.on("dragstart", () => followEnabled = false);
map.on("zoomstart", () => followEnabled = false);


// ======================= TOAST ============================
function showCopiedToast() {
  const toast = document.getElementById("copyToast");
  toast.style.display = "block";
  setTimeout(() => toast.style.display = "none", 1200);
}


// ======================= ЗАГРУЗКА ТОЧЕК pups_m.csv ============================
function normalizeCoord(v) {
  if (!v) return null;
  return parseFloat(
    v.toString().replace(",", ".").replace(/[^\d\.\-]+/g, "").trim()
  );
}

function loadPoints() {
  fetch("pups_m.csv")
    .then(res => res.text())
    .then(csv => {
      Papa.parse(csv, {
        header: true,
        skipEmptyLines: true,
        complete: (data) => {
          data.data.forEach(row => {
            let lat = normalizeCoord(row.lat);
            let lon = normalizeCoord(row.lon);
            if (isNaN(lat) || isNaN(lon)) return;

            L.marker([lat, lon], {
              icon: L.icon({
                iconUrl: "https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-red.png",
                shadowUrl: "https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-shadow.png",
                iconSize: [25, 41],
                iconAnchor: [12, 41]
              })
            }).addTo(pointsLayer);
          });
        }
      });
    });
}


// ======================= ПОЛИГОНЫ ============================
function parseWKTPolygon(wkt) {
  const cleaned = wkt.replace("POLYGON", "")
                     .replace(/\(/g, "")
                     .replace(/\)/g, "")
                     .trim();

  return cleaned.split(",").map(p => {
    const [lon, lat] = p.trim().split(" ").map(Number);
    return [lat, lon];
  });
}

function loadPolygons() {
  fetch("poly.csv")
    .then(res => res.text())
    .then(csv => {
      Papa.parse(csv, {
        header: true,
        skipEmptyLines: true,
        complete: (data) => {
          data.data.forEach(row => {
            if (!row.geom) return;
            if (row.deleted_at && row.deleted_at.trim() !== "") return;

            const geom = row.geom.trim();
            if (!geom.startsWith("POLYGON")) return;

            const coords = parseWKTPolygon(geom);

            const polygon = L.polygon(coords, {
              color: "blue", weight: 2,
              fillColor: "blue", fillOpacity: 0.2
            }).addTo(polygonsLayer);

            if (row.name) polygon.bindTooltip(row.name);

            polygon.on("mouseover", () => polygon.setStyle({ weight: 4, fillOpacity: 0.35 }));
            polygon.on("mouseout",  () => polygon.setStyle({ weight: 2, fillOpacity: 0.2 }));

            polygon.on("click", () => {
              polygon.bindPopup(`
                <div style="font-size:15px;min-width:180px;">
                  <b>Название:</b><br>
                  <input id="polyNameField" value="${row.name || ''}" readonly
                    style="width:100%;margin-top:4px;padding:6px;font-size:14px;">
                  <button onclick="copyPolygonName()" style="margin-top:8px;width:100%;padding:6px;">
                    Скопировать
                  </button>
                </div>
              `).openPopup();
            });
          });

          if (polygonsLayer.getLayers().length)
            map.fitBounds(polygonsLayer.getBounds());
        }
      });
    });
}

window.copyPolygonName = function () {
  const input = document.getElementById("polyNameField");
  if (input) navigator.clipboard.writeText(input.value);
  showCopiedToast();
};


// ======================= СТАРТ ============================
loadPolygons();
loadPoints();

</script>
</body>
</html>

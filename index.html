<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<title>Map Loader</title>
<meta name="viewport" content="width=device-width,initial-scale=1.0" />

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css">
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<style>
  #map { width: 100vw; height: 100vh; }
  button.copy-btn {
    background: #007bff; color: #fff; border: none;
    padding: 6px 10px; border-radius: 4px; cursor: pointer;
  }
</style>
</head>
<body>

<div id="map"></div>

<script>
// ============================
//   БАЗОВАЯ КАРТА
// ============================
const map = L.map('map').setView([-8.05, -34.9], 13);

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  maxZoom: 19
}).addTo(map);


// ============================
//   ФУНКЦИЯ ПАРСИНГА POINT()
// ============================
function parsePointWKT(wkt) {
  const match = wkt.match(/POINT\s*\(\s*(-?\d+\.?\d*)\s+(-?\d+\.?\d*)\s*\)/);
  if (!match) return null;
  return [parseFloat(match[2]), parseFloat(match[1])]; // [lat, lon]
}


// ============================
//   ЗАГРУЗКА ПОЛИГОНОВ
// ============================
fetch("https://dronx777.github.io/pups_checking_recife/poly.csv")
  .then(res => res.text())
  .then(text => {
    const rows = text.split("\n").map(r => r.split(","));

    const header = rows[0];
    const idxGeom = header.indexOf("geom");
    const idxName = header.indexOf("name");
    const idxDeleted = header.indexOf("deleted_at");

    for (let i = 1; i < rows.length; i++) {
      const geom = rows[i][idxGeom];
      const name = rows[i][idxName];
      const deleted = rows[i][idxDeleted];

      if (!geom || geom.indexOf("POLYGON") === -1) continue;
      if (deleted && deleted.trim() !== "") continue; // ❗ скрыть удалённые

      // Парсинг полигона
      const coords = geom
        .replace("POLYGON((", "")
        .replace("))", "")
        .split(",")
        .map(p => {
          const [x, y] = p.trim().split(" ");
          return [parseFloat(y), parseFloat(x)];
        });

      const polygon = L.polygon(coords, {
        color: "blue",
        weight: 2,
        fillOpacity: 0.2
      }).addTo(map);

      // Подпись
      polygon.bindTooltip(name, { permanent: true, direction: "center" });

      // Подсветка
      polygon.on("mouseover", () => polygon.setStyle({ weight: 4 }));
      polygon.on("mouseout", () => polygon.setStyle({ weight: 2 }));

      // Popup с кнопкой копирования
      polygon.bindPopup(`
        <b>${name}</b><br><br>
        <button class="copy-btn" onclick="navigator.clipboard.writeText('${name}')">
            Скопировать
        </button>
      `);
    }
  });


// ============================
//   ЗАГРУЗКА ТОЧЕК
// ============================
fetch("https://dronx777.github.io/pups_checking_recife/pups_m.csv")
  .then(res => res.text())
  .then(text => {
    const rows = text.split("\n").map(r => r.split(","));

    const header = rows[0];
    const idxGeom = header.indexOf("geom");

    for (let i = 1; i < rows.length; i++) {
      const geom = rows[i][idxGeom];
      if (!geom || !geom.includes("POINT")) continue;

      const latlon = parsePointWKT(geom);
      if (!latlon) continue;

      L.circleMarker(latlon, {
        radius: 5,
        color: "red",
        fillColor: "red",
        fillOpacity: 1
      }).addTo(map);
    }
  });

</script>
</body>
</html>

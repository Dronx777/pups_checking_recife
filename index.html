<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<title>Карта + GPS + Полигоны + Pup Points</title>
<meta name="viewport" content="width=device-width,initial-scale=1.0,user-scalable=no" />

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

<style>
  html, body { margin: 0; padding: 0; height: 100%; }
  #map { height: 100vh; width: 100vw; }

  #gpsBtn {
    position: absolute;
    top: 10px;
    left: 50%;
    transform: translateX(-50%);
    z-index: 1000;
    padding: 10px 15px;
    background: white;
    border-radius: 8px;
    border: 1px solid #ccc;
    font-size: 15px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.3);
  }

  #centerBtn {
    position: absolute;
    right: 15px;
    top: 80px;
    width: 50px;
    height: 50px;
    z-index: 1000;
    border-radius: 50%;
    background: white;
    border: 1px solid #ccc;
    box-shadow: 0 2px 6px rgba(0,0,0,0.4);
    display: flex;
    align-items: center;
    justify-content: center;
  }
  #centerBtn::before {
    content: "";
    width: 22px;
    height: 22px;
    border: 2px solid black;
    border-radius: 50%;
  }
  #centerBtn::after {
    content: "";
    width: 3px;
    height: 3px;
    background: black;
    border-radius: 50%;
    position: absolute;
  }

  .sub-label {
    font-size: 14px;
    font-weight: bold;
    color: white;
    text-shadow:
      -1px -1px 0 black,
       1px -1px 0 black,
      -1px  1px 0 black,
       1px  1px 0 black;
    white-space: nowrap;
    transform: translate(-50%, -10px);
  }

  #layersPanel {
    position: absolute;
    left: 10px;
    top: 10px;
    padding: 10px 15px;
    background: white;
    border-radius: 8px;
    border: 1px solid #ccc;
    z-index: 1200;
    box-shadow: 0 2px 6px rgba(0,0,0,0.3);
    font-size: 15px;
  }
  #layersPanel label {
    display: flex;
    align-items: center;
    gap: 6px;
    margin-bottom: 6px;
    cursor: pointer;
  }

  .popup-input { width: 100%; margin-bottom: 6px; padding: 6px; box-sizing: border-box; }
  .popup-readonly { width: 100%; margin-bottom: 6px; padding: 6px; box-sizing: border-box; background: #eee; }
  .popup-btn { width: 100%; padding: 6px; margin-bottom: 4px; cursor: pointer; }
</style>
</head>

<body>

<div id="layersPanel">
  <label><input type="checkbox" id="chkPoly" checked> Полигоны</label>
  <label><input type="checkbox" id="chkPups" checked> Pup Points</label>
</div>

<button id="gpsBtn">GPS</button>
<button id="centerBtn" style="display:none;"></button>
<div id="map"></div>

<script>
// ======================= КАРТА ============================
const map = L.map('map').setView([-8.05, -34.9], 13);
L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

const polygonsLayer = L.layerGroup().addTo(map);
const pointsLayer = L.layerGroup().addTo(map);

// GPS
let userMarker = null;
let watchId = null;
let followEnabled = false;

function updateUserPosition(position) {
  const lat = position.coords.latitude;
  const lon = position.coords.longitude;

  if (!userMarker) {
    userMarker = L.marker([lat, lon]).addTo(map);
    document.getElementById("centerBtn").style.display = "flex";
  } else {
    userMarker.setLatLng([lat, lon]);
  }

  if (followEnabled) map.setView([lat, lon]);
}

document.getElementById("gpsBtn").addEventListener("click", () => {
  navigator.geolocation.getCurrentPosition(
    (pos) => {
      followEnabled = true;
      updateUserPosition(pos);

      if (!watchId) {
        watchId = navigator.geolocation.watchPosition(
          updateUserPosition,
          err => console.warn("watch error", err),
          { enableHighAccuracy: true, maximumAge: 1000, timeout: 15000 }
        );
      }
    },
    () => alert("Разрешите доступ к геолокации."),
    { enableHighAccuracy: true }
  );
});

document.getElementById("centerBtn").addEventListener("click", () => {
  if (!userMarker) return;
  followEnabled = true;
  map.setView(userMarker.getLatLng(), map.getZoom());
});

map.on("dragstart", () => followEnabled = false);
map.on("zoomstart", () => followEnabled = false);

// ======================= ПОЛИГОНЫ ============================
function parseWKTPolygon(wkt) {
  const cleaned = wkt.replace("POLYGON", "").replace(/\(/g, "").replace(/\)/g, "").trim();
  return cleaned.split(",").map(p => {
    const [lon, lat] = p.trim().split(" ").map(Number);
    return [lat, lon];
  });
}

function loadPolygons() {
  fetch("poly.csv")
    .then(res => res.text())
    .then(csv => {
      Papa.parse(csv, {
        header: true,
        skipEmptyLines: true,
        complete: (data) => {

          data.data.forEach(row => {
            if (!row.geom) return;
            if (row.deleted_at && row.deleted_at.trim() !== "") return;

            const geom = row.geom.trim();
            if (!geom.startsWith("POLYGON")) return;

            const coords = parseWKTPolygon(geom);

            const polygon = L.polygon(coords, {
              color: "blue",
              weight: 2,
              fillColor: "blue",
              fillOpacity: 0.2
            }).addTo(polygonsLayer);

            if (row.name) polygon.bindTooltip(row.name);

            polygon.on("mouseover", () => polygon.setStyle({ weight: 4, fillOpacity: 0.35 }));
            polygon.on("mouseout",  () => polygon.setStyle({ weight: 2, fillOpacity: 0.2 }));

            polygon.on("click", () => {
              polygon.bindPopup(`
                <div style="font-size:15px;min-width:180px;">
                  <b>Название:</b><br>
                  <input id="polyNameField" value="${row.name || ''}" readonly
                    style="width:100%;margin-top:4px;padding:6px;font-size:14px;">
                  <button onclick="copyPolygonName()" style="margin-top:8px;width:100%;padding:6px;">
                    Скопировать
                  </button>
                </div>
              `).openPopup();
            });
          });

          if (polygonsLayer.getLayers().length)
            map.fitBounds(polygonsLayer.getBounds());
        }
      });
    });
}

window.copyPolygonName = function () {
  const input = document.getElementById("polyNameField");
  if (input) navigator.clipboard.writeText(input.value);
};

// ======================= PUP POINTS с POPUP ============================
function normalizeCoord(v) {
  if (!v) return null;
  return parseFloat(v.toString().replace(",", ".").replace(/[^\d\.\-]+/g, "").trim());
}

function createPointPopup(point, marker) {
  const container = document.createElement('div');
  container.style.display = 'flex';
  container.style.flexDirection = 'column';
  container.style.gap = '4px';
  container.style.minWidth = '220px';
  container.style.fontSize = '13px';

  // name readonly
  const nameLabel = document.createElement('div'); nameLabel.textContent='name:';
  const nameRead = document.createElement('input'); nameRead.type='text'; nameRead.value=point.name||''; nameRead.readOnly=true; nameRead.className='popup-readonly';
  container.appendChild(nameLabel); container.appendChild(nameRead);

  // name_ch editable
  const nameChLabel = document.createElement('div'); nameChLabel.textContent='изменение name:';
  const nameChInput = document.createElement('input'); nameChInput.type='text'; nameChInput.value=point.name_ch||''; nameChInput.className='popup-input';
  container.appendChild(nameChLabel); container.appendChild(nameChInput);

  // subname readonly
  const subLabel = document.createElement('div'); subLabel.textContent='subname:';
  const subRead = document.createElement('input'); subRead.type='text'; subRead.value=point.subname||''; subRead.readOnly=true; subRead.className='popup-readonly';
  container.appendChild(subLabel); container.appendChild(subRead);

  // subname_ch editable
  const subChLabel = document.createElement('div'); subChLabel.textContent='изменение subname:';
  const subChInput = document.createElement('input'); subChInput.type='text'; subChInput.value=point.subname_ch||''; subChInput.className='popup-input';
  container.appendChild(subChLabel); container.appendChild(subChInput);

  // Кнопки
  const okBtn = document.createElement('button'); okBtn.textContent='Все хорошо'; okBtn.className='popup-btn';
  const needBtn = document.createElement('button'); needBtn.textContent='Нужны изменения'; needBtn.className='popup-btn';
  container.appendChild(okBtn); container.appendChild(needBtn);

  okBtn.addEventListener('click', () => {
    if(nameChInput.value.trim()!=="" || subChInput.value.trim()!=="") { alert("есть изменения"); return; }
    point.status = "1";
    point.name_ch=""; point.subname_ch="";
    marker.setIcon(L.icon({iconUrl:"https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-green.png",
                           shadowUrl:"https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-shadow.png",
                           iconSize:[25,41], iconAnchor:[12,41]}));
    marker.closePopup();
  });

  needBtn.addEventListener('click', () => {
    if(nameChInput.value.trim()==="" || subChInput.value.trim()==="") { alert("нет изменений"); return; }
    point.status = "2";
    point.name_ch = nameChInput.value;
    point.subname_ch = subChInput.value;
    marker.setIcon(L.icon({iconUrl:"https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-orange.png",
                           shadowUrl:"https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-shadow.png",
                           iconSize:[25,41], iconAnchor:[12,41]}));
    marker.closePopup();
  });

  return container;
}

function loadPoints() {
  fetch("pups_m.csv")
    .then(res => res.text())
    .then(csv => {
      Papa.parse(csv, {
        header: true,
        skipEmptyLines: true,
        complete: (data) => {
          data.data.forEach(row => {
            if (row.deleted_at && row.deleted_at.trim() !== "") return;

            let lat = normalizeCoord(row.lat);
            let lon = normalizeCoord(row.lon);
            if (isNaN(lat) || isNaN(lon)) return;

            const point = {
              lat, lon,
              name: row.name||"",
              subname: row.subname||"",
              name_ch: row.name_ch||"",
              subname_ch: row.subname_ch||"",
              status: row.status||"0"
            };

            const marker = L.marker([lat, lon], {
              icon: L.icon({iconUrl:"https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-red.png",
                            shadowUrl:"https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-shadow.png",
                            iconSize:[25,41], iconAnchor:[12,41]})
            }).addTo(pointsLayer);

            marker.bindPopup(createPointPopup(point, marker));

            if (point.subname && point.subname.trim()!=="") {
              const label = L.marker([lat, lon], {
                icon: L.divIcon({className:"", html:`<div class="sub-label">${point.subname}</div>`, iconSize:[0,0], iconAnchor:[0,0]}),
                interactive:false
              });
              pointsLayer.addLayer(label);
            }
          });
        }
      });
    });
}

// ======================= ПЕРЕКЛЮЧАТЕЛИ ============================
document.getElementById("chkPoly").addEventListener("change", function () {
  if (this.checked) map.addLayer(polygonsLayer);
  else map.removeLayer(polygonsLayer);
});

document.getElementById("chkPups").addEventListener("change", function () {
  if (this.checked) map.addLayer(pointsLayer);
  else map.removeLayer(pointsLayer);
});

// ======================= ЗАПУСК ============================
loadPolygons();
loadPoints();
</script>
</body>
</html>
